<div class="p-2 sm:p-6 max-w-7xl mx-auto">
  <h2 class="text-2xl font-medium mb-4">
    Reporte eficiencia de trámites
  </h2>
  <form [formGroup]="filterForm" (ngSubmit)="generate()">
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4">
      <div class="sm:col-span-2">
        <select-search
          [value]="filterForm.get('institution')?.value"
          title="Seleccione la institucion"
          [items]="institutions()"
          (onSelect)="selectInstitution($event)"
        />
      </div>
      <div>
        <mat-form-field>
          <mat-label>Seleccione un rango</mat-label>
          <mat-date-range-input [rangePicker]="picker" [max]="CURRENT_DATE">
            <input
              matStartDate
              placeholder="Fecha inicio"
              formControlName="startDate"
            />
            <input
              matEndDate
              placeholder="Fecha fin"
              formControlName="endDate"
            />
          </mat-date-range-input>
          <mat-datepicker-toggle matIconSuffix [for]="picker" />
          <mat-date-range-picker #picker></mat-date-range-picker>
        </mat-form-field>
      </div>
      <div class="sm:col-span-3">
        <mat-form-field>
          <mat-label>Tipos de trámite</mat-label>
          <mat-chip-grid #chipGrid formControlName="types">
            @for (type of selectedTypes(); track $index) {
            <mat-chip-row [value]="type.value" (removed)="removeType(type)">
              {{ type.label | titlecase }}
              <button matChipRemove>
                <mat-icon>cancel</mat-icon>
              </button>
            </mat-chip-row>
            }
          </mat-chip-grid>
          <input
            placeholder="Buscar tipo de tramite..."
            #filterInput
            [matChipInputFor]="chipGrid"
            [matAutocomplete]="auto"
            [formControl]="filterInputTypes"
          />
          <mat-autocomplete
            #auto="matAutocomplete"
            (optionSelected)="addType($event); filterInput.value = ''"
          >
            @for (type of typesProcedures(); track $index) {
            <mat-option [value]="type">
              {{ type.label | titlecase }}
            </mat-option>
            }
          </mat-autocomplete>
        </mat-form-field>
      </div>
    </div>
    <div class="flex justify-end">
      <button type="submit" matButton="filled" [disabled]="isLoading() || filterForm.invalid">
        Generar
      </button>
    </div>
  </form>


  @if (isLoading()){
  <div class="flex flex-col gap-y-1 mt-4">
    <p class="text-xl">Generando reporte....</p>
    <mat-progress-bar mode="indeterminate" />
  </div>
  } 

  @if(!isLoading() && results().length === 0 && hasSearched()){
    <div class="text-center p-8 text-lg">
      No se encontraron resultados para los filtros seleccionados.
    </div>
  }  

  @if(!isLoading() && results().length > 0){
    <div class="overflow-x-auto mt-6 overflow-y-hidden">
      <table class="min-w-full divide-y-2 divide-gray-200">
        <thead>
          <tr class="*:font-medium *:text-gray-900">
            <th class="px-3 py-2 whitespace-nowrap text-start w-full">
              Tipo de tramite
            </th>
            <th class="px-3 py-2 whitespace-nowrap text-start w-auto">
              Cantidad
            </th>
            <th class="px-3 py-2 whitespace-nowrap text-start w-auto">
              Promedio
            </th>
          </tr>
        </thead>

        <tbody class="divide-y divide-gray-200">
          @for (item of results(); track $index) {
          <tr>
            <td class="px-3 py-2 whitespace-nowrap">{{ item.typeName|titlecase }}</td>
            <td class="px-3 py-2 whitespace-nowrap">{{ item.count }}</td>
            <td class="px-3 py-2 whitespace-nowrap">
              {{ item.averageWorkingDays }} dias
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>
  }
</div>
