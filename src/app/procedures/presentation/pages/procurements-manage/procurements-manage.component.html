<div class="animate-fadeIn">
  <mat-toolbar>
    <span>Contrataciones</span>
    <span class="flex-1"></span>
    <button mat-icon-button (click)="create()">
      <mat-icon>add</mat-icon>
    </button>
  </mat-toolbar>

  <div class="flex justify-end py-2">
    <div class="w-full px-2 sm:w-1/4 h-11">
      <search-input
        [initValue]="term()"
        (onSearch)="search($event)"
        placeholder="Alterno / Referencia"
      />
    </div>
  </div>

  <div class="mat-elevation-z8 sm:px-4">
    <table mat-table [dataSource]="datasource()" multiTemplateDataRows>
      <ng-container matColumnDef="send">
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let element" class="w-8">
          @if(element.isActionable){
          <mat-icon style="color: orangered">mark_email_unread </mat-icon>

          } @else {
          <mat-icon style="color: green">mark_email_read</mat-icon>
          }
        </td>
      </ng-container> 
      <ng-container matColumnDef="code">
        <th mat-header-cell *matHeaderCellDef>Alterno</th>
        <td
          mat-cell
          *matCellDef="let element"
          [id]="element._id"
          class="sm:w-52"
        >
          <a
            [routerLink]="['../procurement', element.group, element.id]"
            class="text-blue-600"
          >
            {{ element.code }}
          </a>
        </td>
      </ng-container>
      <ng-container matColumnDef="reference">
        <th mat-header-cell *matHeaderCellDef>Objeto</th>
        <td mat-cell *matCellDef="let element" class="sm:max-w-80">
          {{ element.reference }}
        </td>
      </ng-container>

      <ng-container matColumnDef="mode">
        <th mat-header-cell *matHeaderCellDef>Tipo</th>
        <td mat-cell *matCellDef="let element">
          {{ element.mode }}
        </td>
      </ng-container>
      <ng-container matColumnDef="createdAt">
        <th mat-header-cell *matHeaderCellDef>Fecha</th>
        <td mat-cell *matCellDef="let element">
          {{ element.createdAt | date : "short" }}
        </td>
      </ng-container>

      <ng-container matColumnDef="expand">
        <th mat-header-cell *matHeaderCellDef aria-label="row actions">
          &nbsp;
        </th>
        <td mat-cell *matCellDef="let element" class="w-8">
          <button
            mat-icon-button
            aria-label="expand row"
            (click)="
              expandedElement = expandedElement === element ? null : element;
              $event.stopPropagation()
            "
          >
            @if (expandedElement === element) {
            <mat-icon>keyboard_arrow_up</mat-icon>
            } @else {
            <mat-icon>keyboard_arrow_down</mat-icon>
            }
          </button>
        </td>
      </ng-container>
      <ng-container matColumnDef="expandedDetail">
        <td
          mat-cell
          *matCellDef="let element"
          [attr.colspan]="displayedColumns.length"
        >
          <div
            class="example-element-detail px-4"
            [@detailExpand]="
              element == expandedElement ? 'expanded' : 'collapsed'
            "
          >
            <div class="pb-6">
              <table class="min-w-full divide-y-2 divide-gray-200 text-sm">
                <thead class="ltr:text-left rtl:text-right">
                  <tr>
                    <th class="whitespace-nowrap px-4 py-2">Cite</th>
                    <th class="whitespace-nowrap px-4 py-2">Referencia</th>
                    <th class="whitespace-nowrap px-4 py-2">Destinatario</th>
                    <th class="whitespace-nowrap px-4 py-2">Fecha</th>
                    <th class="whitespace-nowrap px-4 py-2"></th>
                  </tr>
                </thead>

                <tbody class="divide-y divide-gray-200">
                  @for (doc of element.documents; track $index) {
                  <tr>
                    <td class="whitespace-nowrap px-4 py-2 font-medium">
                      {{ doc.cite }}
                    </td>
                    <td class="whitespace-nowrap px-4 py-2">
                      {{ doc.reference }}
                    </td>
                    <td class="whitespace-nowrap px-4 py-2">
                      {{ doc.recipient?.fullname }}
                    </td>
                    <td class="whitespace-nowrap px-4 py-2">
                      {{ doc.date ? (doc.date | date : "shortDate") : "---" }}
                    </td>
                    <td>
                      <button mat-icon-button [matMenuTriggerFor]="menu">
                        <mat-icon>menu</mat-icon>
                      </button>
                      <mat-menu #menu="matMenu">
                        <button
                          mat-menu-item
                          (click)="updateDocument(element.id, doc, $index)"
                        >
                          <mat-icon>edit</mat-icon>
                          <span>Editar</span>
                        </button>
                        <button
                          mat-menu-item
                          (click)="generateDocument(element, $index)"
                        >
                          <mat-icon>print</mat-icon>
                          <span>Imprimir</span>
                        </button>
                      </mat-menu>
                    </td>
                  </tr>
                  }
                </tbody>
              </table>
            </div>
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="options">
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let row" class="w-8">
          <button
            mat-icon-button
            aria-label="menu options"
            [matMenuTriggerFor]="menu"
          >
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #menu="matMenu">
            <button
              mat-menu-item
            
              (click)="update(row)"
            >
              <mat-icon>edit</mat-icon>
              <span>Editar</span>
            </button>
            <button mat-menu-item (click)="send(row)">
              <mat-icon>send</mat-icon>
              <span>Remitir</span>
            </button>
             <button mat-menu-item (click)="generateRouteSheet(row)">
            <mat-icon>feed</mat-icon>
            <span>Hoja de ruta</span>
          </button>
            <!-- <button mat-menu-item (click)="generateRouteMap(row)">
                <mat-icon>feed</mat-icon>
                <span>Hoja de ruta</span>
              </button>
              <button mat-menu-item (click)="generateTemplate()">
                <mat-icon>feed</mat-icon>
                <span>Plantilla</span>
              </button> -->
          </mat-menu>
        </td>
      </ng-container>
      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr
        mat-row
        *matRowDef="let row; columns: displayedColumns"
        class="example-element-row"
        [class.example-expanded-row]="expandedElement === row"
      ></tr>
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell p-3" colspan="6">SIN RESULTADOS.</td>
      </tr>
      <tr
        mat-row
        *matRowDef="let row; columns: ['expandedDetail']"
        class="example-detail-row"
      ></tr>
    </table>
    @if (datasize() > limit()){
    <mat-paginator
      showFirstLastButtons
      [length]="datasize()"
      [pageIndex]="index()"
      [pageSize]="limit()"
      (page)="onPageChange($event)"
    />
    }
  </div>
</div>
